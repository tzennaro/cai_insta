<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Map Generator</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Manrope', Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        #controls {
            background-color: #fff;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 0 auto 20px auto;
            max-width: 1080px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        .control-group label {
            font-weight: bold;
            margin-right: 10px;
        }
        #download-btn {
            padding: 12px 25px;
            font-size: 18px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-family: 'Manrope', sans-serif;
        }
        #download-btn:disabled {
            background-color: #9e9e9e;
            cursor: not-allowed;
        }
        .overview-wrapper, .map-wrapper {
             margin: 40px auto;
        }
        #overview-map-container, .map-area {
            position: relative;
            width: 1080px;
            height: 1350px;
            margin: 8px auto;
        }
        .map-container {
            width: 100%;
            height: 100%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #ccc;
        }
        .leaflet-container { background: #ffffff; }
        .leaflet-control-attribution { font-size: 10px !important; }
        h1, h2, h3 { font-weight: bolder; margin:0; }
        h3 { font-family: 'Manrope', sans-serif; font-size: 1.2em; }
        .text-overlay {
            position: absolute;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 1);
            padding: 16px 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            text-align: left;
            color: #164182; 
        }
        .text-overlay-top { top: 16px; left: 16px; max-width: 1016px; }
        .text-date { bottom: 144px; right: 16px; max-width: 1016px; }
        .text-overlay-bottom { bottom: 16px; left: 16px; width: 1016px; 
            display: table;
            table-layout: fixed; }
        .overlay-title {
            margin: 0 0 10px 0;
            font-size: 4.5rem;
            line-height: 110%;
            font-weight: bolder;
            color: #164182;
        }
        .title-item { margin-right: 16px; vertical-align: middle; float: left; }
        .title-value { font-size: 4rem; line-height: 110%; }
        .info-item {
            vertical-align: middle;
            display: table-cell;
        }
        .info-label {
            margin-right: 8px;
            vertical-align: middle;
        }
        .info-value {
            vertical-align: middle;
            font-size: 3rem;
            line-height: 110%;
        }
        .overview-title {
            position: absolute;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 1);
            padding: 8px 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            text-align: left;
            width: 1016px;
            color: #164182; 
        }
        .overview-h2 {
            font-size: 6rem;
            text-transform: capitalize;
            line-height: 110%;
            width: fit-content;
            float: left;
        }
        .overview-title img {
            float: right;
        }
        .date-item {
            margin: 0 0 10px 0;
            font-size: 4rem;
            line-height: 110%;
            font-weight: bold;
            color: #164182;
        }
        .center-marker { position: absolute; width: 64px; height: 64px; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; pointer-events: none; }
    </style>
</head>
<body>

    <h1>Dynamic Map Generator</h1>

    <div id="controls">
        <div class="control-group">
            <label for="month-input">1. Set Month:</label>
            <input type="text" id="month-input" placeholder="e.g., Settembre">
        </div>
        <div class="control-group">
            <label for="csv-input">2. Select CSV File:</label>
            <input type="file" id="csv-input" accept=".csv">
        </div>
        <button id="download-btn" disabled>3. Download All as PNG</button>
    </div>

    <div id="overview-wrapper" style="display: none;">
        <h2>Locations Overview</h2>
        <div id="overview-map-container"></div>
    </div>

    <div id="maps-wrapper"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

    <script>
        // --- IMPORTANT ---
        // 1. Get your free API key at https://cloud.maptiler.com/
        // 2. Replace 'YOUR_API_KEY_HERE' with your actual key if needed.
        const MAPTILER_API_KEY = 'eeNaM5hjXgxYpYDXnMxX';
        // ---

        const TARGET_ZOOM = 11;
        const hillshadeOpacity = 0.15;
        const mapsWrapper = document.getElementById('maps-wrapper');
        const csvInput = document.getElementById('csv-input');
        const downloadBtn = document.getElementById('download-btn');
        const overviewWrapper = document.getElementById('overview-wrapper');
        const monthInput = document.getElementById('month-input');

        let createdDetailMaps = [];
        let overviewMap; // Declared here to be accessible later

        function createOverviewMap(locationData) {
            overviewWrapper.style.display = 'block';
            
            const mese = monthInput.value;
            const container = document.getElementById('overview-map-container');
            container.innerHTML = ''; 

            overviewMap = L.map(container.id, {
                zoomControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false
            });

            // Layer 1: Base map (colors)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png').addTo(overviewMap);
            
            // Layer 2: Hillshade (texture)
            L.tileLayer(`https://api.maptiler.com/tiles/hillshade/{z}/{x}/{y}.webp?key=${MAPTILER_API_KEY}`, {
                attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
                opacity: hillshadeOpacity
            }).addTo(overviewMap);

            const svgIcon = L.icon({ iconUrl: 'Images/marker.svg', iconSize: [48, 48] });

            locationData.forEach(location => {
                const lat = parseFloat(location.lat);
                const lon = parseFloat(location.lon);
                if (isNaN(lat) || isNaN(lon)) return;
                L.marker([lat, lon], { icon: svgIcon }).addTo(overviewMap);
            });
            
            const titleOverview = document.createElement('div');
            titleOverview.className = 'overview-title text-overlay-top';
            titleOverview.innerHTML = `<h2 class="overview-h2">Escursioni <br/> ${mese}</h2> <img src="./Images/logo_cai.png" alt="logo Club Alpino Italiano" width="211" height="211">`;
            container.appendChild(titleOverview);

            const bounds = L.latLngBounds([42.615138889, 5.839861111], [47.719027778, 14.278750000]);
            overviewMap.fitBounds(bounds);
        }

        function createBaseMaps(locationData) {
            mapsWrapper.innerHTML = '';
            createdDetailMaps = [];

            locationData.forEach((location, index) => {
                const lat = parseFloat(location.lat);
                const lon = parseFloat(location.lon);
                if (isNaN(lat) || isNaN(lon)) return;

                const wrapper = document.createElement('div');
                wrapper.className = 'map-wrapper';
                const locationTitle = document.createElement('h3');
                locationTitle.textContent = location.nome || `Location ${index + 1}`;
                const mapArea = document.createElement('div');
                mapArea.className = 'map-area';
                mapArea.dataset.name = (location.nome || `map_${index}`).replace(/ /g, '_');
                const mapDiv = document.createElement('div');
                mapDiv.id = `map-${index}`;
                mapDiv.className = 'map-container';

                const topOverlay = document.createElement('div');
                topOverlay.className = 'text-overlay text-overlay-top';
                topOverlay.innerHTML = `<h2 class="overlay-title">${location.nome}</h2><div class="title-item"><span class="title-value">${location.provincia || ''}</span></div>`;

                const bottomOverlay = document.createElement('div');
                bottomOverlay.className = 'text-overlay text-overlay-bottom';
                bottomOverlay.innerHTML = `<div class="info-item">
                        <img class="info-label" src="./Images/quota.svg" alt="icona quota" width="80" height="80">
                        <span class="info-value">${location.quota || ''}</span>
                    </div>
                    <div class="info-item">
                        <img class="info-label" src="./Images/dislivello.svg" alt="icona dislivello" width="80" height="80">
                        <span class="info-value">${location.dislivello || ''}</span>
                    </div>
                    <div class="info-item">
                        <img class="info-label" src="./Images/difficolta.svg" alt="icona difficolta" width="80" height="80">
                        <span class="info-value">${location.difficolta || ''}</span>
                    </div>`;
                
                const dateOverlay = document.createElement('div');
                dateOverlay.className = 'text-overlay text-date';
                dateOverlay.innerHTML = `<div class="date-item">
                        <span>${location.data || ''}</span>
                    </div>`;

                const markerImg = document.createElement('img');
                markerImg.src = 'Images/marker.svg';
                markerImg.className = 'center-marker';

                mapArea.appendChild(mapDiv);
                mapArea.appendChild(topOverlay);
                mapArea.appendChild(bottomOverlay);
                mapArea.appendChild(dateOverlay);
                mapArea.appendChild(markerImg);
                wrapper.appendChild(locationTitle);
                wrapper.appendChild(mapArea);
                mapsWrapper.appendChild(wrapper);

                const map = L.map(mapDiv.id, { zoomControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false });
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { 
                    attribution: '<a href="https://carto.com/attributions" target="_blank">&copy; CARTO</a>'
                }).addTo(map);

                L.tileLayer(`https://api.maptiler.com/tiles/hillshade/{z}/{x}/{y}.webp?key=${MAPTILER_API_KEY}`, {
                    attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
                    opacity: hillshadeOpacity
                }).addTo(map);

                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { 
                    pane: 'tooltipPane', 
                    tileSize: 512, 
                    zoomOffset: -1 
                }).addTo(map);

                map.setView([lat, lon], TARGET_ZOOM);
                createdDetailMaps.push(map);
            });
            
            downloadBtn.disabled = false;
        }

        csvInput.addEventListener('change', event => {
            const file = event.target.files[0];
            if (!file) return;

            if (!MAPTILER_API_KEY || MAPTILER_API_KEY === 'YOUR_API_KEY_HERE') {
                alert('Please add your MapTiler API key to the script first.');
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    createOverviewMap(results.data);
                    createBaseMaps(results.data);
                },
                error: (err) => {
                    alert("Error: Could not parse the CSV file.");
                }
            });
        });

        // This download function is confirmed to be working correctly.
        downloadBtn.addEventListener('click', () => {
            const allMapObjects = [overviewMap, ...createdDetailMaps];
            const allAreas = document.querySelectorAll('#overview-map-container, .map-area');
            const RENDER_DELAY = 2000; // 2-second delay to allow tiles to load.
            const CAPTURE_INTERVAL = RENDER_DELAY + 500; // Time between the start of each capture

            allAreas.forEach((area, index) => {
                const map = allMapObjects[index];
                const isOverview = area.id === 'overview-map-container';
                const filename = isOverview ? '00_overview_map.png' : `${String(index).padStart(2, '0')}_${area.dataset.name || 'map_' + index}.png`;
                
                // Stagger each capture to avoid overwhelming the browser/network
                setTimeout(() => {
                    // Force Leaflet to redraw the map.
                    if (map) {
                        map.invalidateSize(true); 
                    }

                    // Wait for the redraw and tile loading to complete.
                    setTimeout(() => {
                        console.log(`Capturing: ${filename}`);
                        html2canvas(area, { 
                            useCORS: true, // Critical for loading external map tiles
                            logging: false, 
                            scale: 3 
                        }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = filename;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                        }).catch(error => {
                            console.error(`Error capturing ${filename}:`, error);
                            alert(`Failed to download ${filename}. Check the browser console for CORS or network errors.`);
                        });
                    }, RENDER_DELAY);

                }, index * CAPTURE_INTERVAL);
            });
        });
    </script>
</body>
</html>
